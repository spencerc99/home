---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/header/Header.astro";
import Footer from "../components/Footer.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
import Marquee from "../components/Marquee.astro";

export interface BaseLayoutProps {
  title?: string;
  description?: string;
  image?: string;
  includeMarquee?: boolean;
  backgroundOpacity?: number;
  centered?: boolean;
}
type Props = BaseLayoutProps;

const {
  title,
  description,
  image,
  includeMarquee,
  backgroundOpacity,
  centered,
} = Astro.props;
---

<!doctype html>
<html lang="en" transition:name="root" transition:animate="none">
  <head>
    <BaseHead
      title={`${SITE_TITLE}${title ? ` à¼¶ ${title}` : ""}`}
      description={description || SITE_DESCRIPTION}
      image={image}
    />
  </head>
  <body class={centered ? "centered" : ""}>
    <Header transition:persist />
    <div id="construction" transition:persist>
      A
      <br />
      WIP
      <br />
      FOREVER
      <img
        src="https://media.tenor.com/MRCIli40TYoAAAAi/under-construction90s-90s.gif"
        style="width:20px; margin:auto"
      />
    </div>
    <div
      id="background"
      transition:persist
      style={{
        opacity: backgroundOpacity ? backgroundOpacity : 0.2,
      }}
    >
    </div>
    <div id="content">
      <slot />
    </div>
    <Footer transition:persist />

    <div id="snackbar" transition:persist></div>

    <script
      src="https://cursor-party.spencerc99.partykit.dev/cursors.js"
      is:inline
      data-astro-rerun></script>
    <script type="module" is:inline data-astro-rerun>
      import { playhtml } from "https://unpkg.com/playhtml@latest";
      playhtml.init();
    </script>

    <!-- Dark mode script - needs to run on every page -->
    <script is:inline>
      function setDarkMode(state, savePreference = true) {
        document.documentElement.classList.toggle("dark-mode", state);
        const toggle = document.querySelector("#darkModeToggle");
        if (toggle && toggle.children[0]) {
          toggle.children[0].innerHTML = state ? "â˜€ï¸" : "ðŸŒ‘";
        }

        // Save the preference to sessionStorage if needed
        if (savePreference) {
          sessionStorage.setItem("darkMode", state ? "dark" : "light");
        }
      }

      function toggleDarkMode() {
        setDarkMode(!document.documentElement.classList.contains("dark-mode"));
      }

      function initDarkMode() {
        // Initialize dark mode based on the following priority:
        // 1. Previously saved preference in current session
        // 2. System preference
        const savedPreference = sessionStorage.getItem("darkMode");
        const useDark = window.matchMedia("(prefers-color-scheme: dark)");

        if (savedPreference) {
          setDarkMode(savedPreference === "dark", false);
        } else {
          setDarkMode(useDark.matches, false);
        }

        // Update based on system changes only if there's no saved preference
        useDark.addListener((evt) => {
          if (!sessionStorage.getItem("darkMode")) {
            setDarkMode(evt.matches, false);
          }
        });
      }

      // Run on initial load
      document.addEventListener("DOMContentLoaded", initDarkMode);

      // Run after ViewTransitions navigation
      document.addEventListener("astro:after-swap", initDarkMode);
    </script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/playhtml@latest/dist/style.css"
    />

    <link
      rel="preload"
      href="/fonts/Cooper-Regular.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Cooper-Italic.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Cooper-Medium.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Cooper-MediumItalic.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Cooper-SemiBoldItalic.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Cooper-Bold.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Cooper-BoldItalic.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Cooper-ExtraBold.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Cooper-ExtraBoldItalic.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Cooper-Black.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Cooper-BlackItalic.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
  </body>{includeMarquee && <Marquee transition:persist />}
</html>

---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/header/Header.astro";
import Footer from "../components/Footer.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";

export interface BaseLayoutProps {
  title?: string;
  description?: string;
  image?: string;
  backgroundOpacity?: number;
  centered?: boolean;
}
type Props = BaseLayoutProps;

const { title, description, image, backgroundOpacity, centered } = Astro.props;
---

<!doctype html>
<html lang="en" transition:name="root" transition:animate="none">
  <head>
    <BaseHead
      title={`${SITE_TITLE}${title ? ` à¼¶ ${title}` : ""}`}
      description={description || SITE_DESCRIPTION}
      image={image}
    />

    <!-- Blocking dark mode script - must run immediately in head -->
    <script is:inline>
      (async function () {
        const savedPreference = sessionStorage.getItem("darkMode");
        
        if (savedPreference) {
          // Use saved preference if exists
          if (savedPreference === "dark") {
            document.documentElement.classList.add("dark-mode");
          }
          return;
        }

        try {
          // Fetch timezone from status API
          const response = await fetch("https://status.spencer.place/metadata");
          const data = await response.json();
          const timezone = data.timezone;

          if (timezone) {
            // Get current time in Spencer's timezone
            const now = new Date();
            const timeInTimezone = new Intl.DateTimeFormat('en-US', {
              timeZone: timezone,
              hour: 'numeric',
              hour12: false
            }).format(now);
            
            const hour = parseInt(timeInTimezone);
            // Dark mode between 7 PM (19) and 7 AM (7)
            const isNightTime = hour >= 19 || hour < 7;
            
            if (isNightTime) {
              document.documentElement.classList.add("dark-mode");
            }
          } else {
            // Fallback to system preference
            const useDark = window.matchMedia("(prefers-color-scheme: dark)");
            if (useDark.matches) {
              document.documentElement.classList.add("dark-mode");
            }
          }
        } catch (error) {
          // Fallback to system preference on error
          const useDark = window.matchMedia("(prefers-color-scheme: dark)");
          if (useDark.matches) {
            document.documentElement.classList.add("dark-mode");
          }
        }
      })();
    </script>
  </head>
  <body class={centered ? "centered" : ""}>
    <Header transition:persist />
    <div id="construction" transition:persist>
      A
      <br />
      WIP
      <br />
      FOREVER
      <img
        src="https://media.tenor.com/MRCIli40TYoAAAAi/under-construction90s-90s.gif"
        style="width:20px; margin:auto"
      />
    </div>
    <div
      id="background"
      transition:persist
      style={{
        opacity: backgroundOpacity ? backgroundOpacity : 0.2,
      }}
    >
    </div>
    <div id="content">
      <slot />
    </div>
    <Footer transition:persist />

    <div id="snackbar" transition:persist></div>

    <script
      src="https://cursor-party.spencerc99.partykit.dev/cursors.js"
      is:inline
      data-astro-rerun></script>
    <script type="module" is:inline data-astro-rerun>
      import { playhtml } from "https://unpkg.com/playhtml@latest";
      playhtml.init();
    </script>

    <link
      rel="stylesheet"
      href="https://unpkg.com/playhtml@latest/dist/style.css"
    />

    <link
      rel="preload"
      href="/fonts/Cooper-Regular.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Cooper-Italic.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Cooper-Medium.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Cooper-MediumItalic.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Cooper-SemiBoldItalic.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Cooper-Bold.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Cooper-BoldItalic.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Cooper-ExtraBold.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Cooper-ExtraBoldItalic.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Cooper-Black.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/Cooper-BlackItalic.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
  </body>
</html>
